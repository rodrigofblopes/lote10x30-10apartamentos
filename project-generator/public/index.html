<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Dashboards - Projetos Arquitetônicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .file-item {
            transition: all 0.3s ease;
        }
        .file-item:hover {
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="building" class="w-6 h-6 text-white"></i>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-2xl font-bold text-gray-900">Gerador de Dashboards</h1>
                        <p class="text-sm text-gray-500">Projetos Arquitetônicos</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="projectsBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        <i data-lucide="folder" class="w-4 h-4 inline mr-2"></i>
                        Projetos
                    </button>
                    <button id="helpBtn" class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100">
                        <i data-lucide="help-circle" class="w-4 h-4 inline mr-2"></i>
                        Ajuda
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-center space-x-8">
                <div class="flex items-center">
                    <div id="step1" class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">1</div>
                    <span class="ml-2 text-sm font-medium text-gray-900">Upload Arquivos</span>
                </div>
                <div class="w-16 h-0.5 bg-gray-300"></div>
                <div class="flex items-center">
                    <div id="step2" class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm font-medium">2</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">Configurar Projeto</span>
                </div>
                <div class="w-16 h-0.5 bg-gray-300"></div>
                <div class="flex items-center">
                    <div id="step3" class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm font-medium">3</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">Gerar Dashboard</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Upload Files -->
        <div id="step1Content" class="space-y-6">
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Upload de Arquivos</h2>
                
                <!-- Required Files -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Arquivos Obrigatórios</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Orçamento -->
                        <div class="upload-area rounded-lg p-4 text-center" data-file="orcamento">
                            <i data-lucide="file-spreadsheet" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-gray-900">Orçamento</p>
                            <p class="text-xs text-gray-500">.xlsx</p>
                            <input type="file" id="orcamento" accept=".xlsx,.xls" class="hidden">
                        </div>
                        
                        <!-- Modelo Arquitetura -->
                        <div class="upload-area rounded-lg p-4 text-center" data-file="modeloArquitetura">
                            <i data-lucide="box" class="w-8 h-8 text-green-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-gray-900">Modelo 3D Arquitetura</p>
                            <p class="text-xs text-gray-500">.glb</p>
                            <input type="file" id="modeloArquitetura" accept=".glb" class="hidden">
                        </div>
                        
                        <!-- Modelo Estrutural -->
                        <div class="upload-area rounded-lg p-4 text-center" data-file="modeloEstrutural">
                            <i data-lucide="layers" class="w-8 h-8 text-purple-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-gray-900">Modelo 3D Estrutural</p>
                            <p class="text-xs text-gray-500">.glb</p>
                            <input type="file" id="modeloEstrutural" accept=".glb" class="hidden">
                        </div>
                    </div>
                </div>
                
                <!-- Optional Files -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Arquivos Opcionais</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Plantas -->
                        <div class="upload-area rounded-lg p-4 text-center" data-file="plantas">
                            <i data-lucide="image" class="w-8 h-8 text-orange-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-gray-900">Plantas</p>
                            <p class="text-xs text-gray-500">.jpg, .png</p>
                            <input type="file" id="plantas" accept=".jpg,.jpeg,.png" multiple class="hidden">
                        </div>
                        
                        <!-- Relatórios -->
                        <div class="upload-area rounded-lg p-4 text-center" data-file="relatorios">
                            <i data-lucide="file-text" class="w-8 h-8 text-red-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-gray-900">Relatórios</p>
                            <p class="text-xs text-gray-500">.pdf</p>
                            <input type="file" id="relatorios" accept=".pdf" multiple class="hidden">
                        </div>
                        
                        <!-- Logo -->
                        <div class="upload-area rounded-lg p-4 text-center" data-file="logo">
                            <i data-lucide="award" class="w-8 h-8 text-yellow-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-gray-900">Logo</p>
                            <p class="text-xs text-gray-500">.png</p>
                            <input type="file" id="logo" accept=".png" class="hidden">
                        </div>
                    </div>
                </div>
                
                <!-- Upload Button -->
                <div class="flex justify-center">
                    <button id="uploadBtn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="upload" class="w-5 h-5 inline mr-2"></i>
                        Fazer Upload
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Project Configuration -->
        <div id="step2Content" class="hidden space-y-6">
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Configuração do Projeto</h2>
                
                <form id="projectForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Projeto</label>
                            <input type="text" id="projectName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Localização</label>
                            <input type="text" id="projectLocation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="São Paulo, SP">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                        <textarea id="projectDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Descrição do projeto..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Área Total (m²)</label>
                            <input type="number" id="projectArea" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pavimentos</label>
                            <input type="number" id="projectFloors" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Projeto</label>
                            <select id="projectType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="residential">Residencial</option>
                                <option value="commercial">Comercial</option>
                                <option value="industrial">Industrial</option>
                                <option value="institutional">Institucional</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="autoDeploy" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="autoDeploy" class="ml-2 block text-sm text-gray-900">
                            Deploy automático para Vercel
                        </label>
                    </div>
                </form>
            </div>
        </div>

        <!-- Step 3: Generate Dashboard -->
        <div id="step3Content" class="hidden space-y-6">
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Gerar Dashboard</h2>
                
                <div id="generationStatus" class="hidden mb-4">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
                        <span class="text-sm text-gray-600">Gerando projeto...</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="generateBtn" class="px-8 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
                        <i data-lucide="play" class="w-5 h-5 inline mr-2"></i>
                        Gerar Dashboard
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Projects Modal -->
    <div id="projectsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Projetos Gerados</h3>
                    <button id="closeProjectsModal" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="projectsList" class="space-y-2">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Ajuda</h3>
                    <button id="closeHelpModal" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="prose max-w-none">
                    <h4>Arquivos Obrigatórios:</h4>
                    <ul>
                        <li><strong>Orçamento (.xlsx):</strong> Planilha com dados SINAPI</li>
                        <li><strong>Modelo 3D Arquitetura (.glb):</strong> Modelo arquitetônico</li>
                        <li><strong>Modelo 3D Estrutural (.glb):</strong> Modelo estrutural</li>
                    </ul>
                    
                    <h4>Arquivos Opcionais:</h4>
                    <ul>
                        <li><strong>Plantas (.jpg, .png):</strong> Plantas arquitetônicas</li>
                        <li><strong>Relatórios (.pdf):</strong> Relatórios técnicos</li>
                        <li><strong>Logo (.png):</strong> Logo do projeto</li>
                    </ul>
                    
                    <h4>Como Usar:</h4>
                    <ol>
                        <li>Faça upload dos arquivos obrigatórios</li>
                        <li>Configure as informações do projeto</li>
                        <li>Clique em "Gerar Dashboard"</li>
                        <li>Acesse os dashboards gerados</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Global variables
        let currentStep = 1;
        let uploadedFiles = {};
        
        // Step navigation
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('[id$="Content"]').forEach(el => el.classList.add('hidden'));
            
            // Show current step
            document.getElementById(`step${step}Content`).classList.remove('hidden');
            
            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (i <= step) {
                    stepEl.classList.remove('bg-gray-300', 'text-gray-500');
                    stepEl.classList.add('bg-blue-600', 'text-white');
                } else {
                    stepEl.classList.remove('bg-blue-600', 'text-white');
                    stepEl.classList.add('bg-gray-300', 'text-gray-500');
                }
            }
            
            currentStep = step;
        }
        
        // File upload handling
        document.querySelectorAll('.upload-area').forEach(area => {
            const fileInput = area.querySelector('input[type="file"]');
            const fileType = area.dataset.file;
            
            area.addEventListener('click', () => fileInput.click());
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect(fileType, files);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileSelect(fileType, files);
            });
        });
        
        function handleFileSelect(fileType, files) {
            uploadedFiles[fileType] = files;
            
            // Update UI to show selected files
            const area = document.querySelector(`[data-file="${fileType}"]`);
            const icon = area.querySelector('i');
            const text = area.querySelector('p');
            
            if (files.length > 0) {
                icon.classList.add('text-green-600');
                text.textContent = `${files.length} arquivo(s) selecionado(s)`;
            }
        }
        
        // Upload button
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const formData = new FormData();
            
            // Add files to form data
            Object.entries(uploadedFiles).forEach(([type, files]) => {
                files.forEach(file => {
                    formData.append(type, file);
                });
            });
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStep(2);
                } else {
                    alert('Erro no upload: ' + result.error);
                }
            } catch (error) {
                alert('Erro no upload: ' + error.message);
            }
        });
        
        // Generate button
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const form = document.getElementById('projectForm');
            const formData = new FormData(form);
            
            const projectInfo = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                location: document.getElementById('projectLocation').value,
                area: parseInt(document.getElementById('projectArea').value) || 0,
                floors: parseInt(document.getElementById('projectFloors').value) || 0,
                type: document.getElementById('projectType').value,
                autoDeploy: document.getElementById('autoDeploy').checked
            };
            
            if (!projectInfo.name) {
                alert('Nome do projeto é obrigatório');
                return;
            }
            
            document.getElementById('generationStatus').classList.remove('hidden');
            document.getElementById('generateBtn').disabled = true;
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ projectInfo })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Projeto gerado com sucesso!');
                    // Reset form
                    form.reset();
                    uploadedFiles = {};
                    showStep(1);
                } else {
                    alert('Erro na geração: ' + result.error);
                }
            } catch (error) {
                alert('Erro na geração: ' + error.message);
            } finally {
                document.getElementById('generationStatus').classList.add('hidden');
                document.getElementById('generateBtn').disabled = false;
            }
        });
        
        // Projects modal
        document.getElementById('projectsBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/projects');
                const projects = await response.json();
                
                const projectsList = document.getElementById('projectsList');
                projectsList.innerHTML = '';
                
                if (projects.length === 0) {
                    projectsList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum projeto encontrado</p>';
                } else {
                    projects.forEach(project => {
                        const projectEl = document.createElement('div');
                        projectEl.className = 'file-item p-3 border rounded-lg';
                        projectEl.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-900">${project.name}</h4>
                                    <p class="text-sm text-gray-500">${project.config.description}</p>
                                    <p class="text-xs text-gray-400">Criado em: ${new Date(project.createdAt).toLocaleDateString()}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        Abrir
                                    </button>
                                </div>
                            </div>
                        `;
                        projectsList.appendChild(projectEl);
                    });
                }
                
                document.getElementById('projectsModal').classList.remove('hidden');
            } catch (error) {
                alert('Erro ao carregar projetos: ' + error.message);
            }
        });
        
        // Close modals
        document.getElementById('closeProjectsModal').addEventListener('click', () => {
            document.getElementById('projectsModal').classList.add('hidden');
        });
        
        document.getElementById('closeHelpModal').addEventListener('click', () => {
            document.getElementById('helpModal').classList.add('hidden');
        });
        
        document.getElementById('helpBtn').addEventListener('click', () => {
            document.getElementById('helpModal').classList.remove('hidden');
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.id === 'projectsModal') {
                document.getElementById('projectsModal').classList.add('hidden');
            }
            if (e.target.id === 'helpModal') {
                document.getElementById('helpModal').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
